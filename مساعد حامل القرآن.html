<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مساعد حامل القرآن</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Amiri Quran for verses, Cairo for UI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran:wght@400&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Theme Color Variables */
        :root {
            --bg-main: #F0EBE3; --bg-content: #ffffff; --bg-subtle: #f9fafb; --bg-highlight: #D8E4D8;
            --text-main: #3D3B40; --text-title: #4F6F52; --text-subtitle: #739072; --text-placeholder: #6b7280;
            --border-color: #e5e7eb; --accent-color: #86A789; --accent-hover: #6a8b6d;
        }

        /* Base Styles */
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-main); color: var(--text-main); padding-bottom: 80px; }
        .font-amiri-quran { font-family: 'Amiri Quran', serif; }
        .islamic-bg { position: fixed; inset: 0; background-image: url('https://www.transparenttextures.com/patterns/arabesque.png'); opacity: 0.15; z-index: -1; }
        .main-card { background-color: var(--bg-content); border: 1px solid var(--border-color); }
        .modal-content { background-color: var(--bg-content); border: 1px solid var(--border-color); }
        .title { color: var(--text-title); }
        .subtitle { color: var(--text-subtitle); }
        .accent-bg { background-color: var(--accent-color); }
        .accent-bg-hover:hover { background-color: var(--accent-hover); }
        .accent-border { border-color: var(--accent-color); }
        .subtle-bg { background-color: var(--bg-subtle); }
        .highlight-bg { background-color: var(--bg-highlight); }
        .placeholder-text { color: var(--text-placeholder); }
        .custom-select-options .highlighted { background-color: var(--bg-highlight); }
        .nav-btn.active { color: var(--accent-color); font-weight: 600; }
        
        /* Print Styles */
        @media print {
            body { padding-bottom: 0; }
            .no-print { display: none !important; }
            main, header { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; }
            .printable-group, .printable-quiz-section { page-break-inside: avoid; border: 1px solid #ccc !important; padding: 1rem !important; margin-bottom: 1rem !important; border-radius: 0 !important; }
            .quiz-answers-container { display: block !important; border-top: 1px solid #ccc; }
            .quiz-section-content { display: block !important; }
            .quiz-section-snippet { display: none !important; }
        }
    </style>
</head>
<body>
    <div class="islamic-bg"></div>

    <div id="app-container" class="container mx-auto p-4 md:p-8">
        
        <!-- ======================= HOME SCREEN ======================= -->
        <div id="home-screen">
            <header class="text-center mb-12">
                <h1 class="title text-4xl md:text-5xl font-bold">مساعد حامل القرآن</h1>
                <p class="subtitle text-lg mt-2">أداة متكاملة للبحث والمراجعة والتدبر</p>
            </header>
            <div class="max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6">
                <button data-screen="main-app" class="screen-changer text-center p-6 main-card rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1">
                    <svg class="w-12 h-12 mx-auto mb-3 text-[var(--accent-color)] opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M14.5 14.5L19 19"></path></svg>
                    <h2 class="title text-2xl font-bold">بحث المتشابهات</h2>
                    <p class="subtitle mt-1">ابحث عن الآيات المتشابهة</p>
                </button>
                <button data-screen="quiz-setup" class="screen-changer text-center p-6 main-card rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1">
                    <svg class="w-12 h-12 mx-auto mb-3 text-[var(--accent-color)] opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    <h2 class="title text-2xl font-bold">صنع اختبار</h2>
                    <p class="subtitle mt-1">أنشئ اختباراً مخصصاً</p>
                </button>
                 <button data-screen="general-search" class="screen-changer text-center p-6 main-card rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 transform hover:-translate-y-1">
                     <svg class="w-12 h-12 mx-auto mb-3 text-[var(--accent-color)] opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <h2 class="title text-2xl font-bold">الباحث القرآني</h2>
                    <p class="subtitle mt-1">ابحث في نص القرآن كاملاً</p>
                </button>
            </div>
        </div>

        <!-- ======================= GENERAL SEARCH SCREEN ======================= -->
        <div id="general-search-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                 <button data-screen="home" class="screen-changer p-2 rounded-lg subtle-bg border border-[var(--border-color)] no-print" title="العودة للشاشة الرئيسية">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </button>
                <h1 class="title text-3xl font-bold">الباحث القرآني العام</h1>
                <div></div>
            </header>
            <main class="p-6 rounded-2xl shadow-lg main-card">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="gs-query" class="block mb-2 font-semibold">1. أدخل نص البحث:</label>
                        <input type="text" id="gs-query" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg" placeholder="اكتب كلمة أو جزء من آية...">
                    </div>
                    <div>
                        <label for="gs-scope-type" class="block mb-2 font-semibold">2. نطاق البحث:</label>
                        <select id="gs-scope-type" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"></select>
                    </div>
                    <div id="gs-scope-input-container" class="hidden">
                        <label for="gs-scope-input" class="block mb-2 font-semibold">أدخل الأجزاء/الصفحات:</label>
                        <input type="text" id="gs-scope-input" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg">
                    </div>
                    <div id="gs-surah-select-container" class="relative">
                         <label class="block mb-2 font-semibold">اختر من السور:</label>
                         <div id="gs-scope-values" tabindex="0" class="w-full p-2.5 flex items-center subtle-bg border border-[var(--border-color)] rounded-lg cursor-pointer h-11">اختر...</div>
                         <div id="gs-scope-options-container" class="hidden absolute bg-[var(--bg-content)] w-full border border-[var(--border-color)] z-10 max-h-56 overflow-y-auto rounded-md shadow-lg"></div>
                    </div>
                 </div>
                <div id="general-search-results" class="mt-6 space-y-4"></div>
            </main>
        </div>

        <!-- ======================= MAIN APP (SIMILARITIES SEARCH) SCREEN ======================= -->
        <div id="main-app-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <button data-screen="home" class="screen-changer p-2 rounded-lg subtle-bg border border-[var(--border-color)] no-print" title="العودة للشاشة الرئيسية">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </button>
                <h1 class="title text-3xl font-bold">بحث المتشابهات</h1>
                <button id="print-btn" class="p-2 rounded-lg subtle-bg border border-[var(--border-color)] no-print" title="طباعة النتائج"></button>
            </header>
            <main class="p-6 rounded-2xl shadow-lg main-card">
                <!-- Search Config -->
                <div id="config-section" class="no-print grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div class="mt-8 text-center no-print">
                    <button id="search-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-10 rounded-lg transition-transform transform hover:scale-105 shadow-md"></button>
                </div>
                <!-- Search Results -->
                <div id="results-section" class="mt-10">
                    <div id="loading" class="text-center py-10 hidden"></div>
                    <div id="results-container"></div>
                </div>
            </main>
        </div>

        <!-- ======================= QUIZ SETUP SCREEN ======================= -->
        <div id="quiz-setup-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <button data-screen="home" class="screen-changer p-2 rounded-lg subtle-bg border border-[var(--border-color)]" title="العودة للشاشة الرئيسية">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </button>
                <h1 class="title text-3xl font-bold">صنع اختبار</h1>
                <div></div>
            </header>
            <main class="p-6 rounded-2xl shadow-lg main-card max-w-4xl mx-auto">
                <div id="quiz-config-section" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6"></div>
                <div class="mt-8 text-center">
                    <button id="generate-quiz-btn" class="accent-bg accent-bg-hover text-white font-bold py-3 px-10 rounded-lg transition-transform transform hover:scale-105 shadow-md">
                        <svg class="w-6 h-6 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        ابدأ الاختبار
                    </button>
                </div>
            </main>
        </div>

        <!-- ======================= QUIZ DISPLAY SCREEN ======================= -->
        <div id="quiz-display-screen" class="hidden">
             <header class="flex justify-between items-center mb-6">
                <button data-screen="quiz-setup" class="screen-changer p-2 rounded-lg subtle-bg border border-[var(--border-color)] no-print" title="العودة للإعدادات">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </button>
                <h1 class="title text-3xl font-bold">الاختبار</h1>
                 <div class="flex gap-2 no-print">
                    <button id="refresh-quiz-btn" class="flex items-center gap-2 p-2 rounded-lg subtle-bg border border-[var(--border-color)]" title="تحديث الاختبار">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"></path></svg>
                        <span>تحديث</span>
                    </button>
                    <button id="print-quiz-btn" class="p-2 rounded-lg subtle-bg border border-[var(--border-color)] no-print" title="طباعة الاختبار">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    </button>
                 </div>
            </header>
            <main id="quiz-display-container" class="space-y-6"></main>
        </div>

    </div>

    <!-- Bottom Navigation Bar -->
    <nav id="bottom-nav-bar" class="fixed bottom-0 left-0 right-0 bg-[var(--bg-content)] border-t border-[var(--border-color)] shadow-t-lg flex justify-around p-2 z-40 no-print">
        <button data-screen="home" class="nav-btn screen-changer flex flex-col items-center text-xs subtitle">
             <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span>الرئيسية</span>
        </button>
        <button data-screen="general-search" class="nav-btn screen-changer flex flex-col items-center text-xs subtitle">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            <span>الباحث</span>
        </button>
        <button data-screen="main-app" class="nav-btn screen-changer flex flex-col items-center text-xs subtitle">
             <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M14.5 14.5L19 19"></path></svg>
            <span>المتشابهات</span>
        </button>
        <button data-screen="quiz-setup" class="nav-btn screen-changer flex flex-col items-center text-xs subtitle">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span>الاختبار</span>
        </button>
    </nav>
    
    <audio id="audio-player" class="no-print"></audio>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    // --- START OF SCRIPT ---
    // --- DOM Elements ---
    const elements = {
        appContainer: document.getElementById('app-container'),
        audioPlayer: document.getElementById('audio-player'),
        notificationContainer: document.getElementById('notification-container'),
        mainAppScreen: document.getElementById('main-app-screen'),
        quizSetupScreen: document.getElementById('quiz-setup-screen'),
        generalSearchScreen: document.getElementById('general-search-screen'),
        printBtn: document.getElementById('print-btn'),
        configSection: document.getElementById('config-section'),
        searchBtn: document.getElementById('search-btn'),
        loading: document.getElementById('loading'),
        resultsContainer: document.getElementById('results-container'),
        generateQuizBtn: document.getElementById('generate-quiz-btn'),
        quizDisplayContainer: document.getElementById('quiz-display-container'),
        printQuizBtn: document.getElementById('print-quiz-btn'),
        refreshQuizBtn: document.getElementById('refresh-quiz-btn'),
        generalSearchInput: document.getElementById('gs-query'),
        generalSearchResults: document.getElementById('general-search-results'),
        bottomNavBar: document.getElementById('bottom-nav-bar'),
    };
    
    // --- State Variables ---
    let quranData = [], surahMeta = [], selectedSurahs = new Set(), quizSelectedSurahs = new Set(), gsSelectedSurahs = new Set();
    let currentAudio = { button: null, player: elements.audioPlayer };
    let generalSearchDebounce;
    let lastQuizSettings = {};
    const WORDS_PER_PAGE_AVG = 130;

    // --- INITIALIZATION ---
    async function initializeApp() {
        showLoading("جاري تحميل بيانات القرآن الكريم...");
        try {
            const cachedQuran = localStorage.getItem('quran-data-v5');
            if (cachedQuran) {
                const data = JSON.parse(cachedQuran);
                quranData = data.quranData;
                surahMeta = data.surahMeta;
            } else {
                const response = await fetch('https://api.alquran.cloud/v1/quran/quran-uthmani');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                let flatQuranData = [];
                data.data.surahs.forEach(surah => {
                    surah.ayahs.forEach(ayah => {
                        if (ayah.text.startsWith("بِسْمِ ٱللَّهِ")) return;
                        flatQuranData.push({
                            surahNumber: surah.number, surahName: surah.name, ayahNumber: ayah.numberInSurah,
                            text: ayah.text, juz: ayah.juz, page: ayah.page, globalAyahNumber: ayah.number
                        });
                    });
                });
                quranData = flatQuranData;
                surahMeta = data.data.surahs.map(s => ({ number: s.number, name: s.name }));
                localStorage.setItem('quran-data-v5', JSON.stringify({ quranData, surahMeta }));
            }
            setupSearchUI();
            setupQuizUI();
            setupGeneralSearchUI();
            showScreen('home');
        } catch (error) {
            console.error('Failed to initialize app:', error);
            elements.appContainer.innerHTML = `<div class="text-center p-4 bg-red-100 text-red-700 rounded-lg">فشل تحميل بيانات القرآن. يرجى تحديث الصفحة.</div>`;
        }
    }
    
    // --- SCREEN MANAGEMENT ---
    function showScreen(screenName) {
        ['home', 'main-app', 'quiz-setup', 'quiz-display', 'general-search'].forEach(name => {
            const screen = document.getElementById(`${name}-screen`);
            if (screen) screen.classList.add('hidden');
        });
        const activeScreen = document.getElementById(`${screenName}-screen`);
        if (activeScreen) activeScreen.classList.remove('hidden');

        // Nav bar logic
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.screen === screenName || (screenName === 'quiz-display' && btn.dataset.screen === 'quiz-setup')) {
                btn.classList.add('active');
            }
        });
    }
    
    function showLoading(message){
        const loadingHTML = `<div class="text-center py-10"><div class="animate-spin rounded-full h-12 w-12 border-b-4 accent-border mx-auto"></div><p class="mt-4">${message}</p></div>`;
        if (elements.loading) elements.loading.innerHTML = loadingHTML;
        elements.quizDisplayContainer.innerHTML = loadingHTML;
    }
    
    function showNotification(message, type = 'error') {
        const notif = document.createElement('div');
        const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
        notif.className = `${bgColor} p-4 rounded-lg text-white shadow-lg mb-2 transform transition-all duration-300 translate-x-full`;
        notif.textContent = message;
        elements.notificationContainer.appendChild(notif);
        setTimeout(() => notif.classList.remove('translate-x-full'), 10);
        setTimeout(() => {
            notif.classList.add('translate-x-full');
            notif.addEventListener('transitionend', () => notif.remove());
        }, 4000);
    }

    // --- UI SETUP ---
    function setupSearchUI() {
        elements.searchBtn.innerHTML = `<svg class="w-6 h-6 inline-block ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg> ابحث`;
        elements.printBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>`;
        elements.configSection.innerHTML = `
            <div> <label for="search-scope-type" class="block mb-2 font-semibold">1. نطاق البحث:</label> <select id="search-scope-type" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"></select> </div>
            <div id="search-scope-input-container" class="hidden lg:col-span-2"> <label for="search-scope-input" class="block mb-2 font-semibold">أدخل:</label> <input type="text" id="search-scope-input" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"> </div>
            <div id="search-surah-select-container" class="lg:col-span-2 relative"> <label class="block mb-2 font-semibold">اختر السور:</label> <div id="search-scope-values" tabindex="0" class="w-full p-2.5 flex items-center subtle-bg border border-[var(--border-color)] rounded-lg cursor-pointer h-11">اختر...</div> <div id="search-scope-options-container" class="hidden absolute bg-[var(--bg-content)] w-full border border-[var(--border-color)] z-10 max-h-56 overflow-y-auto rounded-md shadow-lg"></div> </div>
            <div> <label for="search-min-match-length" class="block mb-2 font-semibold">3. أقل عدد كلمات:</label> <input type="number" id="search-min-match-length" value="3" min="2" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"> </div>
            <div> <label class="block mb-2 font-semibold">4. موضع التشابه:</label> <div class="flex items-center gap-4 mt-3"> <label><input type="radio" name="search-match-position" value="start" checked class="text-[var(--accent-color)]"> أوائل الآيات</label> <label><input type="radio" name="search-match-position" value="any" class="text-[var(--accent-color)]"> كل المواضع</label> </div> </div>
            <div> <label for="search-ignore-prefixes-input" class="block mb-2 font-semibold">5. تجاهل أحرف:</label> <input type="text" id="search-ignore-prefixes-input" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg" value="و ف"> </div>
            <div> <label class="block mb-2 font-semibold">6. خيارات:</label> <div class="flex items-center mt-3"> <label><input type="checkbox" id="search-memorization-aid" class="rounded text-[var(--accent-color)] ml-2"> مساعدة للحفظ</label> </div> </div>`;
        const scopeTypeSelect = document.getElementById('search-scope-type');
        scopeTypeSelect.innerHTML = `<option value="surah">حسب السورة</option><option value="juz">حسب الجزء</option><option value="page">حسب الصفحة</option>`;
        const surahContainer = document.getElementById('search-surah-select-container');
        const surahValues = document.getElementById('search-scope-values');
        const surahOptions = document.getElementById('search-scope-options-container');
        setupScopeControls(scopeTypeSelect, document.getElementById('search-scope-input-container'), surahContainer, surahValues, surahOptions, selectedSurahs);
        scopeTypeSelect.addEventListener('change', () => setupScopeControls(scopeTypeSelect, document.getElementById('search-scope-input-container'), surahContainer, surahValues, surahOptions, selectedSurahs));
    }

    function setupQuizUI() {
        const quizConfigSection = document.getElementById('quiz-config-section');
        quizConfigSection.innerHTML = `
            <div> <label for="quiz-scope-type" class="block mb-2 font-semibold">1. نطاق الاختبار:</label> <select id="quiz-scope-type" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"></select> </div>
            <div id="quiz-scope-input-container" class="hidden"> <label for="quiz-scope-input" class="block mb-2 font-semibold">أدخل الأجزاء/الصفحات:</label> <input type="text" id="quiz-scope-input" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"> </div>
            <div id="quiz-surah-select-container" class="relative"> <label class="block mb-2 font-semibold">اختر من السور:</label> <div id="quiz-scope-values" tabindex="0" class="w-full p-2.5 flex items-center subtle-bg border border-[var(--border-color)] rounded-lg cursor-pointer h-11">اختر...</div> <div id="quiz-scope-options-container" class="hidden absolute bg-[var(--bg-content)] w-full border border-[var(--border-color)] z-10 max-h-56 overflow-y-auto rounded-md shadow-lg"></div> </div>
            <div> <label for="quiz-difficulty" class="block mb-2 font-semibold">2. مستوى الاختبار:</label> <select id="quiz-difficulty" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"><option value="medium">متوسط</option><option value="easy">سهل</option><option value="hard">صعب</option></select> </div>
            <div> <label for="quiz-total-sections" class="block mb-2 font-semibold">3. إجمالي المقاطع:</label> <input type="number" id="quiz-total-sections" value="5" min="1" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"> </div>
            <div> <label for="quiz-sim-sections" class="block mb-2 font-semibold">4. عدد مقاطع المتشابهات:</label> <input type="number" id="quiz-sim-sections" value="2" min="0" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"> <p class="text-xs subtitle mt-1">ضع 0 لاختبار تسميع فقط</p> </div>
            <div class="md:col-span-2"><hr class="border-[var(--border-color)] my-2"><h4 class="title font-bold">إعدادات المتشابهات (إن وجدت)</h4></div>
            <div> <label for="quiz-min-match-words" class="block mb-2 font-semibold">حد أدنى لكلمات التشابه:</label> <input type="number" id="quiz-min-match-words" value="3" min="2" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"> </div>
            <div> <label for="quiz-max-occurrences" class="block mb-2 font-semibold">حد أقصى لتكرار المتشابهة:</label> <input type="number" id="quiz-max-occurrences" value="5" min="2" class="w-full p-2.5 subtle-bg border border-[var(--border-color)] rounded-lg"> </div>
            `;
        const scopeTypeSelect = document.getElementById('quiz-scope-type');
        scopeTypeSelect.innerHTML = `<option value="surah">حسب السورة</option><option value="juz">حسب الجزء</option><option value="page">حسب الصفحة</option>`;
        const surahContainer = document.getElementById('quiz-surah-select-container');
        const surahValues = document.getElementById('quiz-scope-values');
        const surahOptions = document.getElementById('quiz-scope-options-container');
        setupScopeControls(scopeTypeSelect, document.getElementById('quiz-scope-input-container'), surahContainer, surahValues, surahOptions, quizSelectedSurahs);
        scopeTypeSelect.addEventListener('change', () => setupScopeControls(scopeTypeSelect, document.getElementById('quiz-scope-input-container'), surahContainer, surahValues, surahOptions, quizSelectedSurahs));
    }

    function setupGeneralSearchUI() {
        const scopeTypeSelect = document.getElementById('gs-scope-type');
        scopeTypeSelect.innerHTML = `<option value="all">القرآن كاملاً</option><option value="surah">حسب السورة</option><option value="juz">حسب الجزء</option><option value="page">حسب الصفحة</option>`;
        const surahContainer = document.getElementById('gs-surah-select-container');
        const surahValues = document.getElementById('gs-scope-values');
        const surahOptions = document.getElementById('gs-scope-options-container');
        setupScopeControls(scopeTypeSelect, document.getElementById('gs-scope-input-container'), surahContainer, surahValues, surahOptions, gsSelectedSurahs);
        scopeTypeSelect.addEventListener('change', () => {
            setupScopeControls(scopeTypeSelect, document.getElementById('gs-scope-input-container'), surahContainer, surahValues, surahOptions, gsSelectedSurahs);
            performGeneralSearch();
        });
        document.getElementById('gs-scope-input').addEventListener('input', () => { clearTimeout(generalSearchDebounce); generalSearchDebounce = setTimeout(performGeneralSearch, 400); });
        surahValues.addEventListener('click', () => { setTimeout(performGeneralSearch, 100); });
    }
    
    function setupScopeControls(typeSelect, inputContainer, surahContainer, valuesDiv, optionsContainer, selectionSet) {
        const scope = typeSelect.value;
        if (scope === 'surah') {
            inputContainer.classList.add('hidden');
            surahContainer.classList.remove('hidden');
        } else if (scope === 'all') {
            inputContainer.classList.add('hidden');
            surahContainer.classList.add('hidden');
        }
        else {
            inputContainer.classList.remove('hidden');
            surahContainer.classList.add('hidden');
            const label = inputContainer.querySelector('label');
            const input = inputContainer.querySelector('input');
            label.textContent = scope === 'juz' ? 'أدخل الأجزاء:' : 'أدخل الصفحات:';
            input.placeholder = scope === 'juz' ? 'مثال: 1-10 15' : 'مثال: 22-30 45';
        }
        if (optionsContainer.childElementCount === 0) {
            surahMeta.forEach(surah => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'p-2 flex items-center cursor-pointer hover:bg-[var(--bg-highlight)]';
                optionDiv.innerHTML = `<input type="checkbox" value="${surah.number}" class="form-checkbox h-4 w-4 text-[var(--accent-color)] ml-3 pointer-events-none"> ${surah.number}. ${surah.name}`;
                optionDiv.addEventListener('click', () => {
                    const checkbox = optionDiv.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    if (checkbox.checked) selectionSet.add(String(surah.number));
                    else selectionSet.delete(String(surah.number));
                    if (selectionSet.size === 0) {
                        valuesDiv.textContent = 'اختر...';
                        valuesDiv.classList.add('placeholder-text');
                    } else {
                        valuesDiv.textContent = `تم اختيار ${selectionSet.size} سورة`;
                        valuesDiv.classList.remove('placeholder-text');
                    }
                    if (typeSelect.id === 'gs-scope-type') performGeneralSearch();
                });
                optionsContainer.appendChild(optionDiv);
            });
        }
        valuesDiv.onkeydown = (e) => {
            const options = optionsContainer.querySelectorAll('div');
            let highlightedIndex = Array.from(options).findIndex(opt => opt.classList.contains('highlighted'));
            if (optionsContainer.classList.contains('hidden')) {
                if (e.key === 'Enter' || e.key === ' ') optionsContainer.classList.remove('hidden'); return;
            }
            e.preventDefault();
            if (e.key === 'ArrowDown') highlightedIndex = (highlightedIndex + 1) % options.length;
            else if (e.key === 'ArrowUp') highlightedIndex = (highlightedIndex - 1 + options.length) % options.length;
            else if (e.key === 'Enter' && highlightedIndex > -1) options[highlightedIndex].click();
            else if (e.key === 'Escape') optionsContainer.classList.add('hidden');
            options.forEach((opt, i) => opt.classList.toggle('highlighted', i === highlightedIndex));
            if (highlightedIndex > -1) options[highlightedIndex].scrollIntoView({ block: 'nearest' });
        };
        valuesDiv.onclick = () => optionsContainer.classList.toggle('hidden');
    }

    // --- Core Features: Search, Quiz, Tafsir, Audio ---
    const parseRangeInput = (input) => {
        const values = new Set();
        if (!input) return [];
        input.split(/[\s,]+/).forEach(part => {
            const trimmedPart = part.trim();
            if (!trimmedPart) return;
            if (trimmedPart.includes('-')) {
                const [start, end] = trimmedPart.split('-').map(Number);
                if (!isNaN(start) && !isNaN(end) && start <= end) for (let i = start; i <= end; i++) values.add(i);
            } else {
                const num = Number(trimmedPart);
                if (!isNaN(num)) values.add(num);
            }
        });
        return Array.from(values);
    };
    const normalizeText = (text) => !text ? '' : text.replace(/[\u064B-\u0652\u0670]/g, '').replace(/[أإآ]/g, 'ا').replace(/\u0640/g, '');

    function findSimilarities() {
        const scope = document.getElementById('search-scope-type').value;
        const selectedValuesArray = (scope === 'surah') ? Array.from(selectedSurahs).map(Number) : parseRangeInput(document.getElementById('search-scope-input').value);
        if (selectedValuesArray.length === 0) { showNotification("الرجاء تحديد نطاق للبحث."); return; }
        const minMatchLength = parseInt(document.getElementById('search-min-match-length').value, 10);
        const matchPosition = document.querySelector('input[name="search-match-position"]:checked').value;
        const prefixesToIgnore = document.getElementById('search-ignore-prefixes-input').value.trim().split(/\s+/).filter(p => p);
        const includeAid = document.getElementById('search-memorization-aid').checked;
        showLoading("جاري البحث عن المتشابهات...");
        elements.resultsContainer.innerHTML = elements.loading.innerHTML;
        elements.loading.classList.remove('hidden');
        setTimeout(() => {
            const filteredAyahs = quranData.filter(ayah => {
                if (scope === 'surah') return selectedValuesArray.includes(ayah.surahNumber);
                if (scope === 'juz') return selectedValuesArray.includes(ayah.juz);
                return selectedValuesArray.includes(ayah.page);
            });
            const finalGroups = [];
            const includedVerseLocations = new Set();
            for (let len = 20; len >= minMatchLength; len--) {
                const similaritiesMap = new Map();
                filteredAyahs.forEach(ayah => {
                    const words = ayah.text.split(' ');
                    const normalizedWords = normalizeText(ayah.text).split(' ');
                    const loopLimit = matchPosition === 'start' ? 1 : normalizedWords.length - len + 1;
                    for (let i = 0; i < loopLimit; i++) {
                        if (i + len > words.length) continue;
                        let normalizedNgramArr = normalizedWords.slice(i, i + len);
                        let firstWord = normalizedNgramArr[0];
                        for (const prefix of prefixesToIgnore) { if (firstWord.startsWith(prefix)) { firstWord = firstWord.substring(prefix.length); break; } }
                        normalizedNgramArr[0] = firstWord;
                        const normalizedNgram = normalizedNgramArr.join(' ');
                        if (!normalizedNgram) continue;
                        const originalNgram = words.slice(i, i + len).join(' ');
                        if (!similaritiesMap.has(normalizedNgram)) similaritiesMap.set(normalizedNgram, { original: originalNgram, verses: [] });
                        similaritiesMap.get(normalizedNgram).verses.push({ ...ayah, startIndex: i });
                    }
                });
                similaritiesMap.forEach(group => {
                    if (group.verses.length < 2) return;
                    const isSubset = group.verses.every(v => includedVerseLocations.has(`${v.surahNumber}:${v.ayahNumber}:${v.startIndex}`));
                    if (!isSubset) {
                        finalGroups.push(group);
                        group.verses.forEach(v => includedVerseLocations.add(`${v.surahNumber}:${v.ayahNumber}:${v.startIndex}`));
                    }
                });
            }
            elements.loading.classList.add('hidden');
            renderResults(finalGroups, includeAid);
        }, 100);
    }

    function renderResults(results, includeAid) {
        if (results.length === 0) { elements.resultsContainer.innerHTML = `<div class="text-center p-4 bg-yellow-100 text-yellow-800 rounded-lg">لم يتم العثور على متشابهات.</div>`; return; }
        let html = `<h2 class="title text-2xl font-bold text-center mb-6">نتائج البحث (${results.length} مجموعة)</h2>`;
        results.forEach((group, index) => {
            html += `<div class="printable-group mb-6 main-card p-4 rounded-xl shadow-sm">
                <div class="highlight-bg p-3 rounded-lg mb-4">
                     <div class="flex justify-between items-center">
                        <div>
                            <p class="text-lg font-semibold">التشابه رقم ${index + 1}: <span class="title">"${group.original}"</span></p>
                            <p class="text-sm subtitle">(${group.verses.length} مواضع)</p>
                        </div>
                    </div>
                </div>
                <div class="space-y-3">`;
            group.verses.forEach(v => {
                html += `<div class="border-r-4 accent-border pr-4">
                    <p class="font-amiri-quran text-2xl leading-loose text-right">${v.text}</p>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-left text-sm subtitle">[${v.surahName}: ${v.ayahNumber}]</p>
                        <div class="flex gap-2 no-print">
                            <button class="play-audio-btn" title="استماع" data-global-ayah="${v.globalAyahNumber}"><svg class="w-5 h-5 subtitle" viewBox="0 0 24 24" fill="currentColor"><path d="M3 10v4c0 .55.45 1 1 1h3l7 7V3L7 10H4c-.55 0-1 .45-1 1zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg></button>
                            <button class="show-tafsir-btn" title="تفسير" data-global-ayah="${v.globalAyahNumber}"><svg class="w-5 h-5 subtitle" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM4 18V6h5v12H4zm7 0V6h9v12h-9z"></path><path d="M12 11h3v2h-3z" opacity=".3"></path></svg></button>
                        </div>
                    </div>
                </div>`;
            });
            html += `</div>
            ${includeAid ? generateMemorizationAid(group.verses) : ''}
            </div>`;
        });
        elements.resultsContainer.innerHTML = html;
    }

    function generateMemorizationAid(verses) {
        if (verses.length < 2) return '';
        const verseWords = verses.map(v => v.text.split(' '));
        const differingIndices = new Set();
        for (let i = 0; i < Math.max(...verseWords.map(v => v.length)); i++) {
            const firstWord = normalizeText(verseWords[0]?.[i]);
            for (let j = 1; j < verseWords.length; j++) {
                if (normalizeText(verseWords[j]?.[i]) !== firstWord) { differingIndices.add(i); break; }
            }
        }
        const firstDiffIndex = differingIndices.size > 0 ? Math.min(...differingIndices) : -1;
        if (firstDiffIndex === -1) {
            return `<div class="mt-4 subtle-bg p-4 rounded-lg border-t-4 accent-border"><p class="p-4">النصوص متطابقة تماماً.</p></div>`;
        }
        const versesHtml = verses.map((verse) => {
            const highlightedText = verse.text.split(' ').map((word, wordIndex) => {
                if (wordIndex === firstDiffIndex) { return `<strong class="highlight-bg text-[var(--text-title)] px-1 rounded">${word}</strong>`; }
                return word;
            }).join(' ');
            return `<div><p class="font-amiri-quran text-lg leading-relaxed text-right">${highlightedText}</p><p class="text-xs text-left subtitle mt-1">[${verse.surahName}: ${verse.ayahNumber}]</p></div>`;
        }).join('<hr class="border-[var(--border-color)] my-2">');
        return `<div class="mt-4 subtle-bg p-4 rounded-lg border-t-4 accent-border">
                <p class="font-bold mb-3 title">وجه الاختلاف:</p>
                <div class="space-y-3">${versesHtml}</div>
            </div>`;
    }

    async function showTafsir(globalAyah) {
        const modalContainer = document.createElement('div');
        modalContainer.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 no-print';
        modalContainer.innerHTML = `<div class="modal-content w-full max-w-2xl max-h-[80vh] p-6 rounded-2xl shadow-xl flex flex-col"> <div class="flex justify-between items-center mb-4"> <h3 class="title text-2xl font-bold">التفسير الميسر</h3> <button class="close-modal-btn p-1 rounded-full hover:bg-[var(--bg-subtle)]">&times;</button> </div> <div class="overflow-y-auto pr-2"><p>جاري تحميل التفسير...</p></div> </div>`;
        document.body.appendChild(modalContainer);
        const tafsirBody = modalContainer.querySelector('.overflow-y-auto');
        try {
            const response = await fetch(`https://api.alquran.cloud/v1/ayah/${globalAyah}/ar.muyassar`);
            if (!response.ok) throw new Error('Tafsir not found');
            const data = await response.json();
            tafsirBody.innerHTML = `<p class="font-amiri-quran text-xl leading-loose">${data.data.text}</p>`;
        } catch (error) {
            tafsirBody.innerHTML = '<p>عفواً، لم يتم العثور على التفسير لهذه الآية.</p>';
            console.error("Tafsir fetch error:", error);
        }
    }
    
    function playAudio(button, globalAyah) {
        const player = currentAudio.player;
        if (currentAudio.button === button && !player.paused) {
            player.pause();
            return;
        }
        if (currentAudio.button) {
            currentAudio.button.innerHTML = `<svg class="w-5 h-5 subtitle" viewBox="0 0 24 24" fill="currentColor"><path d="M3 10v4c0 .55.45 1 1 1h3l7 7V3L7 10H4c-.55 0-1 .45-1 1zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>`;
        }
        player.src = `https://cdn.islamic.network/quran/audio/128/ar.alafasy/${globalAyah}.mp3`;
        player.play().catch(e => { if (e.name !== 'AbortError') console.error("Audio play failed:", e) });
        currentAudio.button = button;
    }
    
    currentAudio.player.onplay = () => {
      if(currentAudio.button) currentAudio.button.innerHTML = `<svg class="w-5 h-5 subtitle animate-pulse" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18V6l12 6-12 6z"></path></svg>`;
    };
    currentAudio.player.onpause = currentAudio.player.onended = () => {
      if(currentAudio.button) currentAudio.button.innerHTML = `<svg class="w-5 h-5 subtitle" viewBox="0 0 24 24" fill="currentColor"><path d="M3 10v4c0 .55.45 1 1 1h3l7 7V3L7 10H4c-.55 0-1 .45-1 1zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>`;
      currentAudio.button = null;
    };

    // --- QUIZ & GENERAL SEARCH LOGIC ---
    function generateQuiz(isRefresh = false) {
        let settings;
        if (isRefresh) {
            settings = lastQuizSettings;
        } else {
            settings = {
                scopeType: document.getElementById('quiz-scope-type').value,
                scopeValues: (document.getElementById('quiz-scope-type').value === 'surah') ? Array.from(quizSelectedSurahs).map(Number) : parseRangeInput(document.getElementById('quiz-scope-input').value),
                totalSections: parseInt(document.getElementById('quiz-total-sections').value, 10),
                simSectionsCount: parseInt(document.getElementById('quiz-sim-sections').value, 10),
                minMatchWords: parseInt(document.getElementById('quiz-min-match-words').value, 10),
                maxOccurrences: parseInt(document.getElementById('quiz-max-occurrences').value, 10),
                difficulty: document.getElementById('quiz-difficulty').value
            };
            lastQuizSettings = settings;
        }
        
        if (settings.scopeValues.length === 0) { showNotification('الرجاء تحديد نطاق للاختبار.'); return; }
        if (settings.simSectionsCount > settings.totalSections) { showNotification('عدد مقاطع المتشابهات لا يمكن أن يكون أكبر من إجمالي المقاطع.'); return; }

        showScreen('quiz-display');
        showLoading("جاري إعداد الاختبار...");
        setTimeout(() => {
            const filteredAyahs = quranData.filter(ayah => {
                if (settings.scopeType === 'surah') return settings.scopeValues.includes(ayah.surahNumber);
                if (settings.scopeType === 'juz') return settings.scopeValues.includes(ayah.juz);
                return settings.scopeValues.includes(ayah.page);
            });
            
            let simSections = [];
            let usedSimAyahs = new Set();
            if (settings.simSectionsCount > 0) {
                const similaritiesMap = new Map();
                filteredAyahs.forEach(ayah => {
                    const words = normalizeText(ayah.text).split(' ');
                    if (words.length < settings.minMatchWords) return;
                    const ngram = words.slice(0, settings.minMatchWords).join(' ');
                    if (!similaritiesMap.has(ngram)) similaritiesMap.set(ngram, []);
                    similaritiesMap.get(ngram).push(ayah);
                });
                
                let potentialGroups = [];
                similaritiesMap.forEach(group => {
                    if (group.length > 1 && group.length <= settings.maxOccurrences) {
                        group.difficultyScore = group.reduce((acc, v) => acc + v.text.length, 0); // Simple score
                        potentialGroups.push(group);
                    }
                });

                potentialGroups.sort((a,b) => a.difficultyScore - b.difficultyScore);
                const third = Math.ceil(potentialGroups.length / 3);
                let difficultyPool = potentialGroups;
                if (settings.difficulty === 'easy') difficultyPool = potentialGroups.slice(0, third);
                else if (settings.difficulty === 'hard') difficultyPool = potentialGroups.slice(-third);

                for (let i = 0; i < settings.simSectionsCount && difficultyPool.length > 0; i++) {
                    const randomIndex = Math.floor(Math.random() * difficultyPool.length);
                    const selectedGroup = difficultyPool.splice(randomIndex, 1)[0];
                    simSections.push(buildSection(selectedGroup[0], selectedGroup.slice(1)));
                    selectedGroup.forEach(ayah => usedSimAyahs.add(ayah.globalAyahNumber));
                }
            }

            let recitSections = [];
            const recitSectionsCount = settings.totalSections - simSections.length;
            if (recitSectionsCount > 0) {
                let availableAyahs = filteredAyahs.filter(ayah => !usedSimAyahs.has(ayah.globalAyahNumber));
                 for (let i = 0; i < recitSectionsCount && availableAyahs.length > 0; i++) {
                     const randomIndex = Math.floor(Math.random() * availableAyahs.length);
                     const startAyah = availableAyahs.splice(randomIndex, 1)[0];
                     recitSections.push(buildSection(startAyah, []));
                 }
            }
            
            const quizSections = [...simSections, ...recitSections].sort(() => Math.random() - 0.5);

            if (quizSections.length === 0) {
                elements.quizDisplayContainer.innerHTML = `<div class="text-center p-4 main-card rounded-lg"><p class="text-lg">لم يتم العثور على أي مقاطع تطابق الشروط المحددة.</p></div>`;
                return;
            }
            renderQuizScreen(quizSections);
        }, 100);
    }
    
    function buildSection(startVerse, answers) {
        let sectionText = startVerse.text;
        let words = sectionText.split(' ');
        let lastAyahIndex = quranData.findIndex(a => a.globalAyahNumber === startVerse.globalAyahNumber);
        
        const minWords = Math.floor(WORDS_PER_PAGE_AVG * (2/3)); 

        while(words.length < minWords && lastAyahIndex > -1 && lastAyahIndex + 1 < quranData.length) {
            lastAyahIndex++;
            const nextAyah = quranData[lastAyahIndex];
            if (!nextAyah || nextAyah.surahNumber !== startVerse.surahNumber) { lastAyahIndex--; break; }
            sectionText += ` ${nextAyah.text}`;
            words = sectionText.split(' ');
        }
        const endVerseInfo = quranData[lastAyahIndex];
        return { sectionText: sectionText, startVerseInfo: startVerse, endVerseInfo: endVerseInfo, answers: answers, isSimilarity: answers.length > 0 };
    }

    function renderQuizScreen(sections) {
        let html = '';
        if (sections.length === 0) {
            html = `<div class="main-card p-6 rounded-xl text-center"><h3 class="title text-xl">لا توجد نتائج</h3><p class="subtitle">لم يتم العثور على متشابهات تطابق معايير الاختبار.</p></div>`;
        } else {
            sections.forEach((section, index) => {
                const endVerseText = section.endVerseInfo ? `وينتهي عند [${section.endVerseInfo.surahName}: ${section.endVerseInfo.ayahNumber}]` : '';
                const answerSections = section.answers.map(ans => buildSection(ans, []));
                const answerLocations = section.isSimilarity ? `<span class="no-print"> (وله متشابهات: ${answerSections.map(ansSec => `مقطع يبدأ من [${ansSec.startVerseInfo.surahName}: ${ansSec.startVerseInfo.ayahNumber}] وينتهي عند [${ansSec.endVerseInfo.surahName}: ${ansSec.endVerseInfo.ayahNumber}]`).join('، ')})</span>` : '';
                const snippet = section.sectionText.split(' ').slice(0, 3).join(' ') + ' ...';
                
                html += `<div class="printable-quiz-section main-card p-4 rounded-xl shadow-sm">
                    <h3 class="title font-bold text-lg mb-2">المقطع ${index + 1}</h3>
                    <p class="subtitle text-sm mb-2">من [${section.startVerseInfo.surahName}: ${section.startVerseInfo.ayahNumber}] ${endVerseText}${answerLocations}</p>
                    ${section.isSimilarity ? `<p class="font-bold text-red-600 dark:text-red-400 mb-2 no-print">-- مقطع متشابه --</p>` : ''}
                    
                    <div class="quiz-section-content hidden font-amiri-quran text-xl leading-loose p-4 subtle-bg rounded-lg">${section.sectionText}</div>
                    <div class="quiz-section-snippet p-4 subtle-bg rounded-lg italic placeholder-text"> (يبدأ بـ "${snippet}") </div>

                    <div class="mt-4 text-center no-print"> <button class="reveal-quiz-btn accent-bg accent-bg-hover text-white py-2 px-4 rounded-lg text-sm">${section.isSimilarity ? 'أظهر المقطع والإجابة' : 'أظهر المقطع'}</button> </div>
                    <div class="quiz-answers-container hidden mt-4 space-y-2 border-t border-[var(--border-color)] pt-4">
                        ${section.isSimilarity ? `<p class="font-bold">الإجابة (المواضع الأخرى):</p>
                        ${answerSections.map(ans => `<div class="subtle-bg p-3 rounded-lg"><p class="font-amiri-quran text-lg">${ans.sectionText}</p><p class="text-xs subtitle text-left">[من ${ans.startVerseInfo.surahName}:${ans.startVerseInfo.ayahNumber} إلى ${ans.endVerseInfo.surahName}:${ans.endVerseInfo.ayahNumber}]</p></div>`).join('')}` : ''}
                    </div>
                </div>`;
            });
        }
        elements.quizDisplayContainer.innerHTML = html;
    }

    function performGeneralSearch() {
        const query = elements.generalSearchInput.value.trim();
        const scopeType = document.getElementById('gs-scope-type').value;
        const scopeValues = (scopeType === 'surah') ? Array.from(gsSelectedSurahs).map(Number) : parseRangeInput(document.getElementById('gs-scope-input').value);

        if (query.length < 2) {
            elements.generalSearchResults.innerHTML = `<p class="text-center subtitle">أدخل حرفين على الأقل للبحث.</p>`;
            return;
        }

        elements.generalSearchResults.innerHTML = `<div class="text-center py-5"><div class="animate-spin rounded-full h-6 w-6 border-b-2 accent-border mx-auto"></div></div>`;
        
        setTimeout(() => {
            let searchPool = quranData;
            if (scopeType !== 'all') {
                if (scopeValues.length === 0 && scopeType !== 'all') {
                    elements.generalSearchResults.innerHTML = `<p class="text-center subtitle">الرجاء تحديد نطاق للبحث.</p>`;
                    return;
                }
                searchPool = quranData.filter(ayah => {
                    if (scopeType === 'surah') return scopeValues.includes(ayah.surahNumber);
                    if (scopeType === 'juz') return scopeValues.includes(ayah.juz);
                    if (scopeType === 'page') return scopeValues.includes(ayah.page);
                    return false;
                });
            }

            const normalizedQuery = normalizeText(query);
            const results = searchPool.filter(ayah => normalizeText(ayah.text).includes(normalizedQuery));
            
            let html = `<h3 class="title font-bold text-lg mb-2">نتائج البحث: ${results.length} آية</h3>`;
            if (results.length > 0) {
                html += `<div class="space-y-4">`;
                results.forEach(ayah => {
                    const highlightedText = ayah.text.replace(new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi"), (match) => `<strong class="bg-yellow-200 text-yellow-900">${match}</strong>`);
                    html += `<div class="subtle-bg p-3 rounded-lg"><p class="font-amiri-quran">${highlightedText}</p><p class="text-xs subtitle text-left mt-1">[${ayah.surahName}: ${ayah.ayahNumber}]</p></div>`;
                });
                html += `</div>`;
            } else {
                html += `<p class="text-center subtitle">لم يتم العثور على نتائج.</p>`;
            }
            elements.generalSearchResults.innerHTML = html;
        }, 100);
    }

    // --- EVENT LISTENERS ---
    document.querySelectorAll('.screen-changer').forEach(btn => {
        btn.addEventListener('click', () => showScreen(btn.dataset.screen));
    });
    
    if (elements.printBtn) {
        elements.printBtn.addEventListener('click', () => window.print());
    }
    if (elements.printQuizBtn) {
        elements.printQuizBtn.addEventListener('click', () => window.print());
    }
    if (elements.refreshQuizBtn) {
        elements.refreshQuizBtn.addEventListener('click', () => generateQuiz(true));
    }
    if (elements.searchBtn) {
        elements.searchBtn.addEventListener('click', findSimilarities);
    }
    if (elements.generateQuizBtn) {
        elements.generateQuizBtn.addEventListener('click', () => generateQuiz(false));
    }
    
    // Setup listeners for general search
    if (elements.generalSearchInput) {
        elements.generalSearchInput.addEventListener('input', () => { clearTimeout(generalSearchDebounce); generalSearchDebounce = setTimeout(performGeneralSearch, 400); });
        const gsScopeType = document.getElementById('gs-scope-type');
        if (gsScopeType) gsScopeType.addEventListener('change', performGeneralSearch);
        const gsScopeInput = document.getElementById('gs-scope-input');
        if (gsScopeInput) gsScopeInput.addEventListener('input', () => { clearTimeout(generalSearchDebounce); generalSearchDebounce = setTimeout(performGeneralSearch, 400); });
        const gsSurahContainer = document.getElementById('gs-surah-select-container');
        if (gsSurahContainer) gsSurahContainer.addEventListener('click', () => { setTimeout(performGeneralSearch, 100); });
    }

    document.body.addEventListener('click', (e) => {
        if (e.target.closest('.show-tafsir-btn')) { const btn = e.target.closest('.show-tafsir-btn'); showTafsir(btn.dataset.globalAyah); }
        else if (e.target.closest('.play-audio-btn')) { const btn = e.target.closest('.play-audio-btn'); playAudio(btn, btn.dataset.globalAyah); }
        else if (e.target.closest('.close-modal-btn')) { e.target.closest('.fixed').remove(); }
        else if (e.target.closest('.reveal-quiz-btn')) { 
            const btn = e.target.closest('.reveal-quiz-btn');
            const section = btn.closest('.printable-quiz-section');
            section.querySelector('.quiz-section-content').classList.remove('hidden');
            section.querySelector('.quiz-section-snippet').classList.add('hidden');
            const answerContainer = section.querySelector('.quiz-answers-container');
            if(answerContainer.innerHTML.trim()){
                 answerContainer.classList.remove('hidden');
            }
            btn.remove();
        }
    });
    
    document.addEventListener('click', (e) => {
        const searchSurahContainer = document.getElementById('search-surah-select-container');
        if (searchSurahContainer && !searchSurahContainer.contains(e.target)) { document.getElementById('search-scope-options-container').classList.add('hidden'); }
        const quizSurahContainer = document.getElementById('quiz-surah-select-container');
        if (quizSurahContainer && !quizSurahContainer.contains(e.target)) { document.getElementById('quiz-scope-options-container').classList.add('hidden'); }
        const gsSurahContainer = document.getElementById('gs-surah-select-container');
        if (gsSurahContainer && !gsSurahContainer.contains(e.target)) { document.getElementById('gs-scope-options-container').classList.add('hidden'); }
    });

    // --- START APP ---
    initializeApp();

    });
    </script>
</body>
</html>
